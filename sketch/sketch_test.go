package sketch_test

import (
	"encoding/json"
	"testing"
	"time"

	"github.com/wyattjoh/sketchversion/sketch"
)

const versionData = `[{"Release":"46.2","ReleaseDate":"2017-08-16T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-46.2-44496.zip"},{"Release":"46.1","ReleaseDate":"2017-08-07T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-46.1-44463.zip"},{"Release":"46","ReleaseDate":"2017-07-31T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-46-44423.zip"},{"Release":"45.2","ReleaseDate":"2017-07-13T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-45.2-43514.zip"},{"Release":"45.1","ReleaseDate":"2017-07-03T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-45.1-43504.zip"},{"Release":"45","ReleaseDate":"2017-06-28T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-45-43475.zip"},{"Release":"44.1","ReleaseDate":"2017-05-22T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-44.1-41455.zip"},{"Release":"44","ReleaseDate":"2017-05-12T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-44-41411.zip"},{"Release":"43.2","ReleaseDate":"2017-04-19T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-43.2-39069.zip"},{"Release":"43.1","ReleaseDate":"2017-04-07T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-43.1-39012.zip"},{"Release":"43","ReleaseDate":"2017-04-06T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-43-38999.zip"},{"Release":"42","ReleaseDate":"2017-01-24T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-42.zip"},{"Release":"41.2","ReleaseDate":"2016-11-28T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-41.2.zip"},{"Release":"41.1","ReleaseDate":"2016-11-11T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-41.1.zip"},{"Release":"41","ReleaseDate":"2016-11-08T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-41.zip"},{"Release":"40.3","ReleaseDate":"2016-10-12T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-40.3.zip"},{"Release":"40.2","ReleaseDate":"2016-10-07T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-40.2.zip"},{"Release":"40.1","ReleaseDate":"2016-09-26T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-40.1.zip"},{"Release":"40","ReleaseDate":"2016-09-20T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-40.zip"},{"Release":"39.1","ReleaseDate":"2016-07-25T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-39.1.zip"},{"Release":"39","ReleaseDate":"2016-07-20T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-39.zip"},{"Release":"3.8.3","ReleaseDate":"2016-05-31T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.8.3.zip"},{"Release":"3.8.2","ReleaseDate":"2016-05-24T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.8.2.zip"},{"Release":"3.8.1","ReleaseDate":"2016-05-19T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.8.1.zip"},{"Release":"3.8","ReleaseDate":"2016-05-19T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.8.0.zip"},{"Release":"3.7.2","ReleaseDate":"2016-04-25T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.7.2.zip"},{"Release":"3.7.1","ReleaseDate":"2016-04-18T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.7.1.zip"},{"Release":"3.7","ReleaseDate":"2016-04-13T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.7.0.zip"},{"Release":"3.6.1","ReleaseDate":"2016-03-02T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.6.1.zip"},{"Release":"3.6","ReleaseDate":"2016-03-01T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.6.0.zip"},{"Release":"3.5.2","ReleaseDate":"2016-02-10T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.5.2.zip"},{"Release":"3.5.1","ReleaseDate":"2016-01-26T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.5.1.zip"},{"Release":"3.5","ReleaseDate":"2016-01-26T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.5.0.zip"},{"Release":"3.4.4","ReleaseDate":"2015-12-10T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.4.4.zip"},{"Release":"3.4.3","ReleaseDate":"2015-12-02T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.4.3.zip"},{"Release":"3.4.2","ReleaseDate":"2015-11-16T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.4.2.zip"},{"Release":"3.4.1","ReleaseDate":"2015-11-04T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.4.1.zip"},{"Release":"3.4","ReleaseDate":"2015-10-15T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.4.0.zip"},{"Release":"3.3.3","ReleaseDate":"2015-07-23T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.3.3.zip"},{"Release":"3.3.2","ReleaseDate":"2015-05-04T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.3.2.zip"},{"Release":"3.3.1","ReleaseDate":"2015-04-16T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.3.1.zip"},{"Release":"3.3","ReleaseDate":"2015-03-25T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.3.0.zip"},{"Release":"3.2.2","ReleaseDate":"2014-12-20T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.2.2.zip"},{"Release":"3.2.1","ReleaseDate":"2014-12-11T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.2.1.zip"},{"Release":"3.2","ReleaseDate":"2014-11-21T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.2.0.zip"},{"Release":"3.1.1","ReleaseDate":"2014-10-21T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.1.1.zip"},{"Release":"3.1","ReleaseDate":"2014-09-29T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.1.0.zip"},{"Release":"3.0.4","ReleaseDate":"2014-07-08T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.0.4.zip"},{"Release":"3.0.3","ReleaseDate":"2014-06-05T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.0.3.zip"},{"Release":"3.0.2","ReleaseDate":"2014-05-09T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.0.2.zip"},{"Release":"3.0.1","ReleaseDate":"2014-04-19T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.0.1.zip"},{"Release":"3.0","ReleaseDate":"2014-04-14T00:00:00Z","DownloadURL":"https://download.sketchapp.com/sketch-3.0.1.zip"}]`

func TestFindLatestVersionForLicense(t *testing.T) {
	var releases []sketch.Release
	json.Unmarshal([]byte(versionData), &releases)
	current := time.Unix(1493412066, 0)

	release, err := sketch.FindLatestReleaseForLicense(current, releases)
	if err != nil {
		t.Fatalf("Expected no error, got %v", err)
	}

	if release.Version.String() != "43.2.0" {
		t.Errorf("Expected a match to version 43.2.0, got %s", release.Version.String())
	}
}
